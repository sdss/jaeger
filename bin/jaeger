#!/usr/bin/env python
# encoding: utf-8
#
# @Author: José Sánchez-Gallego
# @Date: Dec 1, 2017
# @Filename: jaeger
# @License: BSD 3-Clause
# @Copyright: José Sánchez-Gallego


from __future__ import absolute_import, division, print_function, unicode_literals

import asyncio
import logging
from functools import update_wrapper

import click
import numpy

from jaeger import log
from jaeger.commands.bootloader import load_firmware
from jaeger.fps import FPS


def cli_coro(f):
    """Decorator function that allows defining coroutines with click."""

    f = asyncio.coroutine(f)

    def wrapper(*args, **kwargs):
        loop = asyncio.get_event_loop()
        return loop.run_until_complete(f(*args, **kwargs))

    return update_wrapper(wrapper, f)


@click.group(invoke_without_command=True)
@click.option('-p', '--profile', type=str, help='the bus interface profile')
@click.option('-l', '--layout', type=str, help='the FPS layout')
@click.option('-a', '--actor', is_flag=True, help='start as an actor')
@click.option('-v', '--verbose', is_flag=True, help='debug mode')
@click.pass_context
@cli_coro
def jaeger(ctx, layout=None, profile=None, actor=False, verbose=False):

    if verbose:
        log.set_level(logging.DEBUG)

    ctx.obj = {}
    ctx.obj['can_profile'] = profile
    ctx.obj['layout'] = layout

    # If we call jaeger without a subcommand and with the actor flag,
    # start the actor.
    if actor and ctx.invoked_subcommand is None:
        fps = FPS(**ctx.obj)
        yield from fps.initialise()
        fps.start_actor()


@jaeger.command(name='upgrade-firmware')
@click.argument('firmware-file', nargs=1, type=click.Path(exists=True))
@click.option('-f', '--force', is_flag=True, help='forces skipping of invalid positioners')
@click.option('-s', '--positioners', type=str, help='comma-separated positioners to upgrade')
@click.pass_context
@cli_coro
def upgrade_firmware(ctx, firmware_file, force=False, positioners=None):
    """Upgrades the firmaware."""

    if positioners is not None:
        positioners = [int(positioner.strip()) for positioner in positioners.split(',')]

    fps = FPS(**ctx.obj)
    yield from fps.initialise()

    yield from load_firmware(fps, firmware_file, positioners=positioners, force=force)


@jaeger.command()
@click.argument('positioner_id', metavar='POSITIONER', nargs=1, type=int)
@click.option('-s', '--speed', type=float,
              help='sets the speed. Otherwise the speed will be '
                   'changed randomly for each move.')
@click.option('-n', '--moves', type=int,
              help='number of moves to perform. Otherwise runs forever.')
@click.pass_context
@cli_coro
def demo(ctx, positioner_id, speed=None, moves=None):
    """Moves a robot to random positions."""

    fps = FPS(**ctx.obj)
    yield from fps.initialise()

    positioner = fps.positioners[positioner_id]
    yield from positioner.initialise()

    if speed is not None:
        yield from positioner.goto(alpha_speed=speed, beta_speed=speed)

    done_moves = 0
    while True:

        alpha = numpy.random.randint(low=0, high=330)
        beta = numpy.random.randint(low=0, high=180)

        if speed is None:
            alpha_speed = numpy.random.randint(low=500, high=2000)
            beta_speed = numpy.random.randint(low=500, high=2000)
        else:
            alpha_speed = beta_speed = None

        yield from positioner.goto(alpha=alpha, beta=beta,
                                   alpha_speed=alpha_speed,
                                   beta_speed=beta_speed)

        done_moves += 1

        if moves is not None and done_moves == moves:
            return



if __name__ == '__main__':
    asyncio.run(jaeger(obj={}))
